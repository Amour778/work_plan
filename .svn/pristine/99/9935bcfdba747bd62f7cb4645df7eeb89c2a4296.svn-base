<%@ page language="java" import="java.util.*" pageEncoding="UTF-8" %>

<a class="layui-btn layui-btn-xs downLoadZipFilesLists">全部下载</a>
<table id="show_wcp_files_table" lay-filter="show_wcp_files_table"></table>

<script type="text/html" id="show_wcp_files_table_bar">
<a class="layui-btn layui-btn-xs btn_class" lay-event="download" >下载</a>
<a class = "layui-btn layui-btn-danger layui-btn-xs btn_class" lay-event="delete" >删除</a>
</script>
<script type="text/javascript">

layui.use(['layer','table','admin'],function() {
    layer = layui.layer
    ,table = layui.table
    ,admin = layui.admin
    ,$ = layui.jquery;
    var project_code=admin.getTempData('project_code');
  //执行渲染
  table.render({
	elem: '#show_wcp_files_table'
	,loading:true
	,url: 'showFilesLists/wcp/'
	,where: {project_code: project_code}
	,even:true
	,cols: [[ //表头
		{field: 'name', width:450,title: '名称'}
		,{fixed: 'right', width:120, align:'center', toolbar: '#show_wcp_files_table_bar'}
	]]
	
	,done: function(res, curr, count){
		if(res.count==0){
			$('.downLoadZipFilesLists').addClass("layui-btn-disabled").attr("disabled", "disabled");
		}
		
	}
  });
	//监听工具条
	table.on('tool(show_wcp_files_table)',
	function(obj) {
		var data = obj.data;
		var layEvent = obj.event;
		if (layEvent === 'download') {
			time(this);
			//window.location.href = "testHttpMessageDown";
			//window.open("downLoadFilesLists/wcp/"+project_code+"?filename=" + data.name);
			window.location.href = "downLoadFilesLists/wcp/"+project_code+"?filename=" + data.name;
		} else if (layEvent === 'delete') {
			layer.confirm('确定删除吗',
			function(index) {
				admin.ajax_load_json({
					url: 'doDeleteFiles/wcp',
					data: {
						file_name: data.name,
						project_code: project_code
					},
					success: function(data, status, xhr) {
						layer.close(index);
						if (data.code == 0) {
							  table.reload('show_wcp_files_table',{
								loading:true
								,url: 'showFilesLists/wcp/'
								,where: {project_code: project_code}
								,done:function(){
									$('.downLoadZipFilesLists').addClass("layui-btn-disabled").attr("disabled", "disabled");
								}
							  });
							layer.msg(data.info, {
								icon: 1
							});
						} else {
							layer.alert(data.info, {
								icon: 5
							});
						}
					}
				});
	
			});
		}
	});
	$('.downLoadZipFilesLists').on('click', function(){
		time(this);
    	window.location.href = "downLoadZipFilesLists/wcp/"+project_code;
  });
		 var wait=10;
	function time(o){
	    if (wait==0) {
	    	o.disabled=false;
	    	o.className ="layui-btn layui-btn-xs";
	    o.innerHTML="下载";
	    wait=5;
	}else{
		o.disabled=true;
		o.className +=" layui-btn-disabled";
	    o.innerHTML=wait;
	        wait--;
	        setTimeout(function(){
	            time(o)
	        },1000)
	    }
	} 
	})
	
</script>