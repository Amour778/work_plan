<%@ page language="java" import="java.util.*" pageEncoding="UTF-8" %>
	<%@taglib prefix="shiro" uri="http://shiro.apache.org/tags" %>
		<form class="layui-form  model-form" action="" id="up_div">
			<div class="layui-form-item">
				<label class="layui-form-label">
					选择进度
				</label>
				<div class="layui-input-block">
					<select name="project_progress" lay-verify="required" lay-filter="project_progress"
					id="project_progress">
					</select>
				</div>
			</div>
			<div id="is_have_returned_money_div" v-show="project_progress == 100">
				<div class="layui-form-item">
					<label class="layui-form-label">
						是否有质保金
					</label>
					<div class="layui-input-block">
						<input type="radio" name="returned_money_ishave" value="N" title="否" lay-filter="wcp_update_progress_radio"
						checked>
						<input type="radio" name="returned_money_ishave" value="Y" title="是" lay-filter="wcp_update_progress_radio">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">
						余料库存
					</label>
					<div class="layui-input-block">
						<input type="text" class="layui-input" v-bind:lay-verify="finshrequired"
						id="remaining_stock" name="remaining_stock" lay-verType="tips" autocomplete="off">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">
						已收款金额
					</label>
					<div class="layui-input-block">
						<input type="text" class="layui-input" v-bind:lay-verify="finshrequired"
						id="received_amount" name="received_amount" v-model.number="received_amount"
						lay-verType="tips" autocomplete="off">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">
						待收金额
					</label>
					<div class="layui-input-block">
						<input type="text" class="layui-input" v-bind:lay-verify="finshrequired"
						id="amount_to_be_collected" v-model.number="amount_to_be_collected" name="amount_to_be_collected"
						lay-verType="tips" autocomplete="off" readOnly>
					</div>
				</div>
				<div v-show="checked == 'Y'">
					<div class="layui-form-item">
						<label class="layui-form-label">
							预估回款日期
						</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input" v-bind:lay-verify="required" id="returned_money_date"
							name="returned_money_date" lay-verType="tips">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">
							质保金点数
						</label>
						<div class="layui-input-block">
							<select name="returned_money_point" lay-filter="returned_money_point"
							id="returned_money_point" v-bind:lay-verify="required" lay-verType="tips"
							lay-search>
							</select>
						</div>
					</div>
				</div>
				<div>
					<div class="layui-form-item">
						<label class="layui-form-label">
							开票金额
						</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input layui-disabled" disabled placeholder="=本金+税额6~11%"
							v-model:number="kp" id="kp">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">
							项目报价
						</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input layui-disabled" disabled v-model:number="project_quotation"
							id="project_quotation">
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">
							备注
						</label>
						<div class="layui-input-block">
							<input type="text" class="layui-input" v-bind:placeholder="remark_placeholder"
							v-bind:lay-verify="remark_required" id="remark" name="remark" lay-verType="tips">
						</div>
					</div>
				</div>
			</div>
			<div class="layui-form-item model-form-footer">
				<button class="layui-btn btn_class" lay-filter="user-form-submit" id="save_btn"
				lay-submit>
					保存
				</button>
			</div>
			<hr/>
			<div class="layui-form-item" v-show="project_progress != 100">
				<label class="layui-form-label">
					上传附件
				</label>
				<div class="layui-input-block">
					<button type="button" class="layui-btn btn_class" id="upload_file_wcp_progress">
						<i class="layui-icon">
							&#xe67c;
						</i>
						上传附件
					</button>
				</div>
				<div class="layui-form-mid layui-word-aux">
					一次只能上传一个文件，单个文件大小不可超过50MB，合同不可分多个文件上传
				</div>
				<div>
					<table class="layui-table" sytle="height:400px" id="upload_files_table"
					name="upload_files_table" lay-filter="upload_files_table_filter">
						<colgroup>
							<col width="200">
								<col width="150">
									<col width="200">
										<col width="200">
						</colgroup>
						<tbody id="layui-progress-big">
						</tbody>
					</table>
				</div>
			</div>
		</form>
		<script type="text/html" id="upload_files_table_bar">
			<a class = "layui-btn layui-btn-danger layui-btn-xs  btn_class" lay-event="del"> 删除 </a>
		</script>
		<script type="text/javascript">
			layui.use(['laydate', 'carousel', 'layer', 'form', 'admin', 'jquery', 'upload', 'element', 'table'],
			function() {

				var $ = layui.jquery,
				laydate = layui.laydate,
				carousel = layui.carousel,
				admin = layui.admin,
				upload = layui.upload,
				form = layui.form,
				element = layui.element,
				table = layui.table,
				layer = layui.layer;

				var project_code = admin.getTempData('project_code');
				var project_progress = admin.getTempData('project_progress');
				//console.log(project_code);
				//console.log(project_progress);
				var xhrOnProgress = function(fun) {
					xhrOnProgress.onprogress = fun; //绑定监听
					//使用闭包实现监听绑
					return function() {
						//通过$.ajaxSettings.xhr();获得XMLHttpRequest对象
						var xhr = $.ajaxSettings.xhr();
						//判断监听函数是否为函数
						if (typeof xhrOnProgress.onprogress !== 'function') return xhr;
						//如果有监听函数并且xhr对象支持绑定时就把监听函数绑定上去
						if (xhrOnProgress.onprogress && xhr.upload) {
							xhr.upload.onprogress = xhrOnProgress.onprogress;
						}
						return xhr;
					}
				}
				var vm = new Vue({
					el: '#up_div',
					data: {
						project_progress: project_progress,
						required: 'N',
						remark_required: 'N',
						checked: 'N',
						finshrequired: 'N',
						remark_required: 'N',
						amount_to_be_collected: 0,
						received_amount: 0,
						remark_placeholder: ''
						//,full_amount_of_tax:0
						,
						kp: 0,
						project_quotation: 0
					},
					watch: {
						received_amount: function(val) {
							this.amount_to_be_collected = (this.project_quotation - val).toFixed(2);
						}
					},
					computed: {

					},
				});

				//通过项目编码获取相关信息
				$.post("queryWCProjectsSimpleDetailAllInfoByProjectCode", {
					project_code: admin.getTempData('project_code')
				},
				function(data) {
					if (data.code == 1) {
						layer.msg(data.info);
					} else {
						//vm.full_amount_of_tax = data.info[0].full_amount_of_tax;
						vm.kp = (data.info[0].principal * 1 + data.info[0].tax_money * 1).toFixed(2);
						vm.project_quotation = data.info[0].project_quotation;
						vm.amount_to_be_collected = vm.project_quotation;
						if (vm.kp != vm.project_quotation) {
							remark_required = 'required';
							this.remark_placeholder = '[开票金额]与[项目报价]不一致，请说明原因';
						} else {
							remark_required = 'N';
						}
					}
				},
				'json');
				element.render('progress');
				var upload_files_table_oldData = new Array();;
				table.render({
					id: 'upload_files_table',
					elem: '#upload_files_table',
					data: upload_files_table_oldData,
					page: false,
					limit: 999,
					//设置每页显示条数
					cols: [[{
						field: 'file_name',
						title: '文件名'
					},
					{
						field: 'file_size',
						title: '文件大小'
					},
					{
						field: 'file_proportion',
						title: '上传状态',
						width: 350
					},
					{
						field: null,
						title: '操作',
						templet: '#upload_files_table_bar',
					}]]
				});
				var select = "";
				var dis = true;

				var enrollArr = [];
				var demoCount = 0,
				demoFlag = false;
				var demoClass;
				//上传文件
				upload.render({
					elem: '#upload_file_wcp_progress',
					accept: 'file',
					multiple: false,
					//是否允许多文件上传
					size: 50 * 1024,
					//文件最大50兆
					url: 'doUploadFiles/wcp/' + project_code + '_' + vm.project_progress,
					xhr: xhrOnProgress,
					progress: function(value) {
						if (demoFlag) {
							element.progress('demo' + demoCount, value + '%') //设置页面进度条
							$('.btn_class').addClass("layui-btn-disabled").attr("disabled", "disabled");
						}
					},
					before: function(obj) {
						layer.load();
						upload_files_table_oldData = table.cache["upload_files_table"];
						obj.preview(function(index, file, result) {
							layer.closeAll('loading'); //关闭loading
							demoCount++;
							var size = file.size / 1024 / 1024;
							if (size <= 1) {
								size = keepTwoDecimal(size * 1024) + 'KB';
							} else {
								size = keepTwoDecimal(size) + 'MB';
							}

							var data1 = {};
							data1 = {
								"file_name": file.name,
								"file_size": size,
								"file_proportion": "上传中..."
							}
							upload_files_table_oldData.push(data1);
							table.reload('upload_files_table', {
								data: upload_files_table_oldData,
								page: false
							});
							demoFlag = true;

						})
					},
					error: function(index, upload) {
						element.progress('demo' + demoCount, '0%');
						layer.msg('上传失败');
					},
					choose: function(obj) {
						demoFlag = false;
					},
					done: function(res) {
						if (res.code == '200') {
							enrollArr.push(res.data[0]);
						} else {
							$('.btn_class').removeClass("layui-btn-disabled").removeAttr("disabled");
							upload_files_table_oldData = table.cache["upload_files_table"];
							var length = upload_files_table_oldData.length - 1;
							upload_files_table_oldData[length].file_proportion = res.info;
							table.reload('upload_files_table', {
								data: upload_files_table_oldData,
								page: false
							});
							console.log(upload_files_table_oldData[length].file_proportion);
						}
					}
				});
				table.on('tool(upload_files_table_filter)',
				function(obj) {
					var data = obj.data;
					if (obj.event === 'del') {
						layer.confirm('确定删除吗',
						function(index) {
							console.log("data.file_proportion", data.file_proportion);
							admin.ajax_load_json({
								url: 'doDeleteFiles/wcp',
								data:{
									file_name : data.file_proportion,
									project_code : project_code
								},
								success: function(data, status, xhr) {
									layer.close(index);
									if (data.code == 0) {
										obj.del();
										/*upload_files_table_oldData = table.cache["upload_files_table"];
										table.reload('upload_files_table', {
											data: upload_files_table_oldData,
											page: false
										});*/
										layer.msg(data.info, {
											icon: 1
										});
									} else {
										layer.alert(data.info, {
											icon: 5
										});
									}
								}
							});

							
						});
					}
				});
				//下拉框初始化
				var mycars = new Array();
				mycars[0] = "0,未开工";
				mycars[1] = "30,已开工30%";
				mycars[2] = "70,已开工70%";
				mycars[3] = "90,已竣工";
				mycars[4] = "99,已验收";
				mycars[5] = "100,结项";
				for (var a = 0; a < mycars.length; a++) {
					var value = mycars[a].split(",")[0];
					var text = mycars[a].split(",")[1];
					if (dis == true) {
						if (project_progress == value) {
							select += "<option value=" + value + " selected>" + text + "</option>";
							dis = false;
							if (value == 100) {
								$("#save_btn").text("申请结项");
								vm.finshrequired = "required";
								//通过项目编码获取相关信息
								$.post("querySimpleInfoByProject_code", {
									project_code: admin.getTempData('project_code')
								},
								function(data) {
									if (data.code == 1) {
										layer.alert(data.info);
										$("#save_btn").addClass("layui-btn-disabled").attr("disabled", "disabled");
									}
								},
								'json');
							} else {
								$("#save_btn").text("保存");
								vm.finshrequired = "N";
							}
						} else {
							select += "<option value=" + value + " disabled>" + text + "</option>";
						}
					} else {
						select += "<option value=" + value + ">" + text + "</option>";
					}
				}
				$("#project_progress").html(select);
				//下拉框初始化
				var returned_money_poin_select = "<option></option>";
				for (var a = 0; a < 100; a++) {
					var value = a * 0.01;
					var text = a + "%";
					if (value == 0.05) {
						returned_money_poin_select += "<option value=" + value + " selected>" + text + "</option>";
					} else {
						returned_money_poin_select += "<option value=" + value + ">" + text + "</option>";
					}
				}
				$("#returned_money_point").html(returned_money_poin_select);
				form.render();
				//下拉框事件
				form.on('select(project_progress)',
				function(data) {
					project_progress = data.value;
					vm.project_progress = data.value;
					if (data.value == 100) {
						//通过项目编码获取相关信息
						$("#save_btn").text("申请结项");
						vm.finshrequired = "required";
						$.post("querySimpleInfoByProject_code", {
							project_code: admin.getTempData('project_code')
						},
						function(data) {
							if (data.code == 1) {
								layer.alert(data.info);
								$("#save_btn").addClass("layui-btn-disabled").attr("disabled", "disabled");
							}
						},
						'json');
					} else {
						$("#save_btn").text("保存");
						vm.finshrequired = "N";
					}
				});
				form.on('select(returned_money_point)',
				function(data) {
					vm.returned_money_point = data.value;
				});
				//单选框事件
				form.on('radio(wcp_update_progress_radio)',
				function(data) {
					console.log(data.value);
					vm.checked = data.value;
					console.log("单选框事件vm.checked=" + vm.checked);
					if (data.value == "N") {
						vm.required = 'N';
					} else if (data.value == "Y") {
						vm.required = 'required';
					}
					console.log('单选框事件vm.project_progress=' + vm.project_progress);
					console.log('单选框事件vm.required=' + vm.required);

					laydate.render({
						elem: '#returned_money_date',
						istime: false,
						value: new Date()
					});
				});

				//提交更新
				form.on('submit(user-form-submit)',
				function(data) {
					var returned_money_ishave = null,
					returned_money_date = null,
					returned_money_point = null;
					if (project_progress == 100) {
						if (vm.required == 'N') {
							returned_money_ishave = data.field.returned_money_ishave;
						} else {
							returned_money_ishave = data.field.returned_money_ishave;
							returned_money_date = data.field.returned_money_date;
							returned_money_point = data.field.returned_money_point;
						}
						if (vm.amount_to_be_collected < 0 || vm.amount_to_be_collected == 'NaN') {
							layer.msg("[待收金额]数据异常");
							return false;
						}
						if (data.field.returned_money_ishave == 'Y') {
							if ((vm.amount_to_be_collected / vm.kp).toFixed(2) != data.field.returned_money_point) {
								if (data.field.remark == '') {
									layer.alert("[待收金额" + vm.amount_to_be_collected + "]÷[开票金额" + vm.kp + "]=" + (vm.amount_to_be_collected / vm.kp).toFixed(2) + ",不等于所选择的质保金比例:" + data.field.returned_money_point + ",请说明原因");
									//this.remark_placeholder='[待收金额]÷[开票金额]不等于5%，请说明原因';
									return false;
								}
							}
						}
						if (data.field.returned_money_ishave == 'N' && vm.amount_to_be_collected != 0) {
							if (data.field.remark == '') {

								layer.msg("无质保金，待收金额不为0,请说明原因");
								return false;
							}
						}
					}
					console.log("returned_money_ishave=" + returned_money_ishave);
					console.log("returned_money_date=" + returned_money_date);
					console.log("returned_money_point=" + returned_money_point);
					admin.ajax_load_json({
						url: 'updataWeakCurrentProjectsDetailProgressByProjectCode',
						data: {
							project_progress: project_progress,
							project_code: project_code,
							returned_money_ishave: returned_money_ishave,
							returned_money_date: returned_money_date,
							returned_money_point: returned_money_point,
							remaining_stock: data.field.remaining_stock,
							received_amount: data.field.received_amount,
							amount_to_be_collected: data.field.amount_to_be_collected,
							project_progress_remake: data.field.remark
						},
						success: function(data) {
							if (data.code == 0) {
								layer.closeAll();
								layer.msg(data.info, {
									icon: 1
								});
							} else {
								layer.closeAll('loading');
								layer.alert(data.info, {
									icon: 5
								});
							}
						}
					});
					return false;
				});
				function keepTwoDecimal(num) {
					var result = parseFloat(num);
					result = Math.round(num * 100) / 100;
					return result;
				}
				var pathName = window.document.location.pathname;
				var projectName = pathName.substring(0, pathName.substr(1).indexOf('/') + 1);
				function DEL(path) {
					console.log(path);
					admin.ajax_load_json({
						url: projectName + '/delPic/' + path.split("/")[2] + '/' + path.split("/")[3],
						success: function(data) {
							if (data.code == 0) {
								layer.msg("删除成功！", {
									icon: 1
								});
							} else {
								layer.msg("删除失败！", {
									icon: 5
								});
							}
						}
					});

				}

			});
</script>